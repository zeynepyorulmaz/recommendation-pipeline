name: Deploy to EC2

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      deploy_method:
        description: 'Deployment method'
        required: true
        default: 'cloudformation'
        type: choice
        options:
          - cloudformation
          - direct-ec2
          - s3-deploy

env:
  AWS_DEFAULT_REGION: us-east-1
  AWS_REGION: us-east-1

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1
        
    - name: Create deployment package
      run: |
        echo "ğŸ“¦ Creating deployment package..."
        chmod +x ./deploy-robust.sh
        ./deploy-robust.sh
        echo "âœ… Deployment package created: $(ls -lh deployment-package.tar.gz)"
        
    - name: Deploy using CloudFormation
      if: github.event.inputs.deploy_method == 'cloudformation' || github.event_name == 'push'
      run: |
        echo "ğŸš€ Deploying using CloudFormation..."
        chmod +x ./deploy-cloudformation.sh
        ./deploy-cloudformation.sh
        
    - name: Deploy directly to EC2
      if: github.event.inputs.deploy_method == 'direct-ec2'
      run: |
        echo "ğŸš€ Deploying directly to EC2..."
        chmod +x ./deploy-ec2-simple.sh
        ./deploy-ec2-simple.sh
        
    - name: Deploy to S3
      if: github.event.inputs.deploy_method == 's3-deploy'
      run: |
        echo "ğŸš€ Deploying to S3..."
        aws s3 cp deployment-package.tar.gz s3://your-bucket-name/
        echo "âœ… Package uploaded to S3"
        
    - name: Show deployment status
      run: |
        echo "ğŸ‰ Deployment completed!"
        echo "ğŸ“‹ Check AWS Console for details"
        echo "ğŸŒ Application should be available at the provided URL" 